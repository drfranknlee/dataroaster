- name: add vault repo
  shell: "{{ item }}"
  args:
    executable: /bin/bash
  with_items:
    - "yum install -y yum-utils"
    - "yum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo"
  become: true
  ignore_errors: true

- name: install vault binary
  yum:
    name: vault-1.6.3-1.x86_64
    state: present
  become: true

- name: create temp directory
  file:
    path: "{{ item }}"
    state: directory
  with_items:
    - "{{ vault_temp_dir }}"

- name: copy files to create certs
  template:
    src: "templates/{{ item }}"
    dest: "{{ vault_temp_dir }}/{{ item }}"
    mode: 0755
  with_items:
    - "create-cert.sh"
    - "intermediate.cnf"
    - "openssl.cnf"

- name: create cert
  shell: "{{ item }}"
  args:
    executable: /bin/bash
    chdir: "{{ vault_temp_dir }}"
  with_items:
    - "./create-cert.sh"
  become: true

- name: copy certs to vault conf directory
  shell: "{{ item }}"
  args:
    executable: /bin/bash
    chdir: "{{ vault_temp_dir }}"
  with_items:
    - "cp work/ca/certs/localhost.cert.pem {{ vault_conf_dir }}/localhost.cert.pem"
    - "cp work/ca/private/localhost.decrypted.key.pem {{ vault_conf_dir }}/localhost.decrypted.key.pem"
    - "cp work/keystore.jks {{ vault_conf_dir }}/keystore.jks"
    - "chown vault:vault -R {{ vault_conf_dir }}"
    - "chmod 777 -R {{ vault_conf_dir }}/"
  become: true

- name: copy vault configuration
  template:
    src: "templates/{{ item }}"
    dest: "{{ vault_conf_dir }}/{{ item }}"
    mode: 0755
  with_items:
    - "vault.hcl"
  become: true

- name: copy vault service
  template:
    src: "templates/{{ item }}"
    dest: "/etc/systemd/system/{{ item }}"
    mode: 0755
  with_items:
    - "vault.service"
  become: true

- name: start vault
  service:
    name: vault
    state: started
  become: true

- name: remove temp dir
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - "{{ vault_temp_dir }}"

- name: init vault
  shell: "{{ item }}"
  args:
    executable: /bin/bash
  with_items:
    - "vault operator init"
  environment:
    VAULT_ADDR: https://localhost:8200
    VAULT_SKIP_VERIFY: true
  register: vault_init_out
  become: true

- debug:
    msg: "{{ vault_init_out }}"

